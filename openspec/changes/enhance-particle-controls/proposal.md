# 提案：增强粒子控制系统 (Enhance Particle Controls)

## 背景
基于已完成的 `simulate-emergence` 基础实现，用户反馈了以下问题：
1. **性能问题**：原始实现仅 14 FPS，需要性能优化
2. **交互性不足**：缺少暂停、预设规则、布局控制等功能
3. **参数失控**：原始参数范围过大导致粒子变成噪声
4. **粒子塌缩**：粒子会合并成一个点，缺乏默认排斥力

## 目标
在已有的 Particle Life 模拟器基础上进行全面增强：
- 性能优化至 30+ FPS (同等粒子数)
- 添加完整的控制面板 UI
- 提供多种力矩阵预设和初始布局选项
- 实现短程排斥力防止粒子塌缩

## 核心变更

### 1. 性能优化
- **消除每帧内存分配**：将 `particleCellIds` 从循环内分配移至类成员预分配
- **减少默认粒子数**：从 100k 降至 50k（可通过 UI 调整）
- **优化力计算**：合并 `1/dist` 计算，减少除法次数

### 2. UI 控制面板
- **暂停/继续按钮**：支持暂停模拟 + 空格键快捷键
- **参数滑块**：粒子数、阻力、力量强度、交互半径、短程排斥
- **颜色选择器**：6种粒子颜色可自定义
- **力矩阵编辑器**：6×6 可视化矩阵，点击/滚轮调整

### 3. 力矩阵预设 (8种)
| 预设 | 行为描述 |
|------|----------|
| 🎲 随机 | 随机生成力矩阵 |
| 🐍 贪吃蛇 | 每种颜色追逐下一种颜色，形成链条 |
| 🌌 星系 | 同色吸引，异色微弱排斥，形成星系 |
| 🏘️ 族群 | 相邻颜色吸引，形成聚落 |
| 🦁 捕食者 | 食物链循环追逐 |
| 🤝 共生 | 两两互相吸引形成对称结构 |
| 🌀 混沌 | 交替吸引排斥，产生涡流 |
| 🫧 膜结构 | 自排斥+异吸引，形成细胞膜边界 |

### 4. 初始布局预设 (6种)
| 布局 | 描述 |
|------|------|
| 🎲 随机 | 均匀随机分布（默认） |
| ⭕ 环形 | 粒子排列成环，颜色按角度分布 |
| 🟦 色块 | 每种颜色一个矩形区域 |
| 🎯 中心 | 所有粒子聚集中心（观察爆发） |
| 📐 网格 | 整齐的网格排列 |
| 🌀 螺旋 | 螺旋状分布 |

### 5. 短程排斥力
- **新增参数**：`REPULSION_STRENGTH` (0 ~ 0.8), `REPULSION_RADIUS` (0.008)
- **作用**：粒子距离过近时产生排斥力，防止合并成一个点

### 6. 参数范围微调
| 参数 | 旧范围 | 新范围 | 理由 |
|------|--------|--------|------|
| 粒子数 | 10k-200k | 10k-100k | 平衡性能和效果 |
| 阻力 | 0.5-0.99 | 0.85-0.98 | 避免过快衰减或振荡 |
| 力量强度 | 1-50 | 2-20 | 避免粒子变成噪声 |
| 交互半径 | 0.01-0.05 | 0.015-0.04 | 更微妙的控制 |

## 理由
- **性能是体验的基础**：14 FPS 无法观察到有意义的涌现现象
- **预设降低门槛**：用户无需手动调参即可看到有趣的行为
- **默认排斥力增加多样性**：防止所有粒子最终合成一团
- **参数范围约束**：引导用户在"有意义"的参数空间内探索

## 影响范围
- `particle life/src/params.ts` - 参数定义、预设数据
- `particle life/src/simulation.ts` - 布局初始化、排斥力逻辑
- `particle life/src/ui.ts` - 完整控制面板 (新增)
- `particle life/src/main.ts` - 暂停逻辑集成
- `particle life/src/renderer.ts` - 使用共享调色板
