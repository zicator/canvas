# 提案：AI 图像生成画布完整集成方案

## 背景

本项目旨在基于开源项目 `tldraw` 构建一个 AI 图像生成画布应用，允许用户直接在无限画布上调用 AI 生成图片。项目采用分阶段迭代的方式，目前已完成了两个主要阶段的开发工作。

## 项目现状分析

### 已完成功能（Phase 1: AI Canvas Framework）

**✅ 基础架构搭建**
- 使用 Vite + React + TypeScript 初始化项目
- 集成 `tldraw` SDK v3，实现无限画布功能
- 配置开发环境和构建工具

**✅ 核心功能实现**
- **自定义 AI Frame 形状** (`AIFrameShape`)
  - 支持四种状态：`empty`（空状态）、`generating`（生成中）、`success`（成功）、`failed`（失败）
  - 实现了完整的渲染逻辑和状态转换
  - 支持在画布上创建、选择和编辑 AI Frame

- **Mock 生成服务** (`MockGenerationService`)
  - 实现了标准化的 `IGenerationService` 接口
  - 模拟网络延迟（2-5秒随机延迟）
  - 返回占位图片（使用 Lorem Picsum API）
  - 为未来接入真实 AI API 做好了接口抽象

- **生成服务接口定义** (`GenerationService.ts`)
  - 定义了 `GenerationRequest` 和 `GenerationResponse` 接口
  - 支持 prompt、尺寸、seed 等参数
  - 预留了扩展能力（如 negativePrompt、流式传输等）

### 已完成功能（Phase 2: Agent Sidebar Integration）

**✅ UI 布局重构**
- **左侧工具栏** (`LeftToolbar`)
  - 垂直布局的工具栏组件
  - 集成 tldraw 标准工具（选择、手型、绘制等）
  - 支持创建新的 AI Frame

- **Agent 侧边栏** (`AgentSidebar`)
  - 可折叠的右侧面板（宽度 320px）
  - 平滑的滑入/滑出动画效果
  - 包含聊天历史记录和输入区域

- **统一输入组件** (`UnifiedInput`)
  - 支持两种模式：`bottom`（底部浮动）和 `sidebar`（侧边栏内）
  - 自动调整高度的文本输入框
  - 集成设置选项：宽高比（1:1, 16:9, 4:3）和分辨率（2k, 4k）
  - 支持 Enter 键提交，Shift+Enter 换行

**✅ 状态管理**
- 使用 Zustand 实现全局状态管理 (`store.ts`)
  - UI 状态：侧边栏开关状态
  - Agent 状态：提示词、生成设置、聊天历史
  - 消息管理：添加、更新消息的完整逻辑

**✅ 生成流程同步**
- 实现了画布和侧边栏的双向同步
  - 用户输入提示词后，自动在侧边栏创建用户消息
  - 同时在画布中心创建 AI Frame（生成中状态）
  - 生成完成后，同时更新侧边栏聊天记录和画布上的 Frame
  - 支持错误处理和失败状态显示

**✅ 聊天历史功能**
- `ChatList` 组件展示完整的对话历史
- 支持用户消息和助手消息的区分显示
- 显示生成状态（生成中、成功、失败）
- 成功时显示生成的图片预览

### 待完成功能

**⚠️ E2E 验证** (`integrate-agent-sidebar` 的最后一项任务)
- 需要验证布局的完整性和响应式表现
- 验证输入在不同模式间的状态持久化
- 验证生成流程的端到端同步正确性
- 测试边界情况和错误处理

**⚠️ 代码完善**
- `LeftToolbar` 组件文件缺失（MainLayout 中有引用但文件不存在）
- 需要补充完整的组件实现

## 问题陈述

虽然两个阶段的核心功能已经实现，但存在以下问题：

1. **提案碎片化**：两个提案（`ai-canvas-framework` 和 `integrate-agent-sidebar`）是分阶段提出的，缺乏统一的整体视角
2. **文档不完整**：缺少一个完整的中文提案文档，整合所有功能点和实现状态
3. **验证不充分**：E2E 验证任务尚未完成，可能存在未发现的问题
4. **组件缺失**：部分引用的组件文件缺失，需要补充实现

## 解决方案

### 目标

创建一个完整、统一的中文提案文档，整合两个阶段的成果，清晰展示：
- 项目的完整功能范围
- 当前实现状态和完成度
- 剩余待完成的工作
- 未来扩展方向

### 范围

**包含内容：**
- 整合两个提案的核心内容
- 详细的功能实现状态分析
- 完整的架构设计说明
- 清晰的任务完成度评估
- 未来迭代计划

**不包含：**
- 新的功能开发（仅文档整合）
- 代码实现（仅提案阶段）
- 真实 AI API 集成（规划在后续阶段）

## 架构概览

### 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    用户界面层                            │
├──────────┬──────────────────────────┬──────────────────┤
│ 左侧工具栏 │      无限画布 (tldraw)      │   Agent 侧边栏  │
│          │                          │                  │
│ - 工具按钮 │  - AI Frame 形状         │  - 聊天历史      │
│ - 创建Frame│  - 生成状态显示           │  - 统一输入      │
│          │  - 图片渲染               │  - 设置选项      │
└──────────┴──────────────────────────┴──────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│                   状态管理层 (Zustand)                   │
│  - UI 状态（侧边栏开关）                                  │
│  - Agent 状态（提示词、设置、历史）                        │
└─────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│                   服务层 (Service Layer)                  │
│                                                          │
│  ┌────────────────────────────────────────────┐         │
│  │  IGenerationService (接口)                 │         │
│  └────────────────────────────────────────────┘         │
│                    │                                     │
│        ┌────────────┴────────────┐                      │
│        ▼                         ▼                      │
│  MockGenerationService    RealService (未来)            │
│  - 模拟延迟                  - Stable Diffusion         │
│  - 占位图片                  - Midjourney               │
└─────────────────────────────────────────────────────────┘
```

### 核心组件说明

1. **画布模块** (`Canvas Module`)
   - 基于 `tldraw` SDK，提供无限画布能力
   - `AIFrameShape` 自定义形状，支持完整的生成生命周期

2. **UI 布局模块** (`Layout Module`)
   - `MainLayout`：主布局容器，协调所有 UI 组件
   - `LeftToolbar`：左侧工具栏（待完善）
   - `AgentSidebar`：右侧 Agent 交互面板
   - `UnifiedInput`：统一输入组件

3. **状态管理模块** (`State Management`)
   - Zustand store 管理全局应用状态
   - 支持 UI 状态、Agent 状态、聊天历史的统一管理

4. **服务层** (`Service Layer`)
   - 标准化的生成服务接口
   - Mock 实现用于快速迭代和测试
   - 为未来真实 API 集成预留接口

### 数据流

1. **用户输入流程**
   ```
   用户在 UnifiedInput 输入提示词
   → 选择宽高比和分辨率设置
   → 点击生成或按 Enter
   → MainLayout.handleGenerate() 被调用
   ```

2. **生成流程**
   ```
   清空输入框
   → 打开侧边栏（如果关闭）
   → 添加用户消息到聊天历史
   → 添加助手消息（生成中状态）
   → 在画布中心创建 AI Frame（生成中状态）
   → 调用 MockGenerationService.generate()
   → 等待 2-5 秒（模拟延迟）
   → 更新助手消息（成功状态 + 图片 URL）
   → 更新画布上的 AI Frame（成功状态 + 图片 URL）
   ```

3. **错误处理流程**
   ```
   生成失败
   → 更新助手消息（失败状态）
   → 更新画布上的 AI Frame（失败状态）
   → 显示错误提示
   ```

## 视口展示与控制逻辑规范

为确保用户在连续生成过程中的视觉体验流畅且不被干扰，系统需遵循以下视口控制规范。

### 1. 安全视口 (Safe Viewport) 定义

安全视口是指除去所有 UI 元素及预留缓冲空间后的画布有效展示区域。视口计算需基于当前窗口尺寸动态排除以下边距（Padding）：

- **基础边距定义**：
  - **Top**: 80px (顶部导航栏 + 缓冲)
  - **Left**: 80px (左侧工具栏 + 缓冲)
  - **Bottom**: 160px (底部输入框区域 + 缓冲)
  - **Right**: 
    - 侧边栏 **收起** 时: 80px
    - 侧边栏 **展开** 时: 400px (侧边栏宽度 320px + 缓冲 80px)

### 2. 视口行为规则

系统根据生成产物（New Content）与当前视口（Current Viewport）的位置关系，执行不同的行为策略。

#### 规则 A：完全视口内展示 (Inside Viewport)
- **判定条件**：新生成产物的包围盒（Bounding Box）**完全包含**在当前安全视口范围内。
- **系统行为**：**保持静止**，不执行任何缩放或平移操作。
- **设计目的**：避免不必要的微小移动干扰用户视线，保持上下文稳定。

#### 规则 B：超出安全视口展示 (Outside Viewport)
- **判定条件**：新生成产物的任意部分**超出**当前安全视口范围。
- **系统行为**：执行**联合适配（Union Fit）**。
  1. **计算联合包围盒**：`UnionBounds = CurrentViewportBounds + NewContentBounds`
  2. **视口适配**：将相机（Camera）调整至能完整包含 `UnionBounds` 的状态，并确保其位于安全视口区域内。
  3. **动画过渡**：视口变化过程需应用 **300ms** 的缓动（Ease-in-out）过渡效果，避免突变造成的视觉跳跃。
  4. **限制**：
     - 保持合理的缩放比例（Zoom Level），避免过度缩小。
     - 确保新产物在视觉上的可见性。

### 3. 视口控制功能设计

#### 控制台入口优化
- **位置**：顶部导航栏一级菜单。
- **名称**：`开发者模式`。
- **交互**：点击直接展开下拉菜单，无需二级路径。

#### 安全视口可视化
- **功能**：在 开发者模式 菜单中提供 "展示安全视口" 开关。
- **表现**：开启时，在画布上以半透明覆盖层或虚线框形式标示出当前的安全视口范围（Padding 区域）。
- **持久化**：用户偏好设置需保存至本地存储（LocalStorage）。

### 4. 判定流程图

```mermaid
graph TD
    A[生成请求完成] --> B{侧边栏状态?}
    B -->|展开| C[计算安全视口 (R=400px)]
    B -->|收起| D[计算安全视口 (R=80px)]
    C --> E[获取产物包围盒]
    D --> E
    E --> F{产物在安全视口内?}
    F -->|是| G[保持视口静止]
    F -->|否| H[计算联合包围盒]
    H --> I[执行视口适配动画]
```

## 技术栈

- **前端框架**：React 18 + TypeScript
- **构建工具**：Vite
- **画布库**：tldraw v3
- **状态管理**：Zustand
- **样式方案**：内联样式（可考虑迁移到 CSS Modules 或 Tailwind）

## 实现状态总结

| 功能模块 | 完成度 | 状态 |
|---------|--------|------|
| 项目初始化 | 100% | ✅ 完成 |
| tldraw 集成 | 100% | ✅ 完成 |
| AI Frame 形状 | 100% | ✅ 完成 |
| Mock 生成服务 | 100% | ✅ 完成 |
| 状态管理 (Zustand) | 100% | ✅ 完成 |
| Agent 侧边栏 | 100% | ✅ 完成 |
| 统一输入组件 | 100% | ✅ 完成 |
| 生成流程同步 | 100% | ✅ 完成 |
| 聊天历史显示 | 100% | ✅ 完成 |
| 左侧工具栏 | ~80% | ⚠️ 文件缺失 |
| E2E 验证 | 0% | ❌ 未完成 |

**总体完成度：约 90%**

## 风险与挑战

1. **组件缺失风险**
   - `LeftToolbar` 组件被引用但文件不存在，可能导致运行时错误
   - **缓解措施**：需要补充实现或移除引用

2. **状态同步复杂性**
   - 画布和侧边栏的状态同步可能存在竞态条件
   - **缓解措施**：已实现状态检查（`editor.getShape()`），但需要更全面的测试

3. **性能考虑**
   - 大量 AI Frame 可能影响画布性能
   - **缓解措施**：未来可考虑虚拟化或懒加载

4. **扩展性**
   - 当前架构支持未来扩展，但需要确保接口设计的灵活性
   - **缓解措施**：已定义标准化接口，便于替换实现

## 未来规划

### 短期（下一阶段）

1. **完善现有功能**
   - 补充 `LeftToolbar` 组件实现
   - 完成 E2E 验证测试
   - 修复潜在 bug 和边界情况

2. **用户体验优化**
   - 改进加载动画和过渡效果
   - 优化响应式布局
   - 添加键盘快捷键支持

### 中期（后续迭代）

1. **真实 AI API 集成**
   - 集成 Stable Diffusion API
   - 支持 Midjourney 或其他服务
   - 实现流式传输和进度更新

2. **高级功能**
   - 图片编辑和重绘（Inpainting）
   - 批量生成
   - 生成历史管理

### 长期（愿景）

1. **协作功能**
   - 多人实时协作
   - 分享和导出功能

2. **AI 能力增强**
   - 智能布局建议
   - 自动优化提示词
   - 风格迁移和变换

## 总结

本项目已经完成了核心功能的开发，包括：
- ✅ 基于 tldraw 的无限画布
- ✅ AI Frame 自定义形状和生成流程
- ✅ Mock 生成服务
- ✅ Agent 侧边栏和统一输入
- ✅ 完整的状态管理和同步机制

剩余工作主要是：
- ⚠️ 补充缺失的组件实现
- ⚠️ 完成 E2E 验证
- ⚠️ 优化和打磨用户体验

整体架构设计合理，为未来扩展打下了良好基础。建议优先完成剩余的基础工作，然后进入下一阶段的真实 API 集成。
